<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Orchestration Console</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --border: #d8dde6;
            --border-light: #eaecf0;
            --text: #172b4d;
            --text-secondary: #5e6c84;
            --text-muted: #97a0af;
            --primary: #0052cc;
            --primary-hover: #0747a6;
            --primary-light: #e4f0ff;
            --danger: #de350b;
            --danger-hover: #bf2600;
            --success: #00875a;
            --warning: #f59e0b;
            --column-bg: #ebecf0;
            --card-hover: #f4f5f7;
            --shadow: 0 1px 2px rgba(9,30,66,0.08), 0 0 1px rgba(9,30,66,0.12);
            --shadow-md: 0 4px 8px rgba(9,30,66,0.12), 0 0 1px rgba(9,30,66,0.12);
            --topbar-bg: #0d1b2a;
            --topbar-height: 40px;
            --sidebar-bg: #1a2535;
            --sidebar-hover: rgba(255,255,255,0.07);
            --sidebar-active: rgba(0,82,204,0.3);
            --sidebar-active-border: #4c9aff;
            --sidebar-text: rgba(255,255,255,0.85);
            --sidebar-text-muted: rgba(255,255,255,0.45);
            --sidebar-width: 260px;
        }

        /* Skip link (T07 accessibility) */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: #fff;
            padding: 6px 12px;
            border-radius: 0 0 3px 0;
            font-size: 13px;
            font-weight: 600;
            z-index: 1000;
            transition: top .15s;
            text-decoration: none;
        }
        .skip-link:focus { top: 0; outline: 2px solid #fff; outline-offset: 2px; }

        /* Focus indicators (T07) */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Topbar (T06: slim 40px branding header) */
        .topbar {
            background: var(--topbar-bg);
            color: #fff;
            height: var(--topbar-height);
            display: flex;
            align-items: center;
            padding: 0 12px 0 0;
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }
        .sidebar-toggle {
            width: var(--topbar-height);
            height: var(--topbar-height);
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background .15s, color .15s;
        }
        .sidebar-toggle:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .topbar-brand {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.9);
            white-space: nowrap;
            padding-left: 4px;
        }
        .topbar-brand span { color: #4c9aff; }
        .topbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        .live-dot {
            width: 6px; height: 6px;
            background: #36b37e;
            border-radius: 50%;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
        .live-dot.active { animation: blink 2s infinite; }
        .topbar-label { font-size: 11px; color: rgba(255,255,255,.5); }
        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.8);
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background .15s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.18); }
        .btn-icon[aria-pressed="true"] { background: rgba(0,82,204,0.5); border-color: #4c9aff; color: #fff; }

        /* App Layout: sidebar + main (T02) */
        .app-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            flex: 1;
            overflow: hidden;
            transition: grid-template-columns .2s ease;
        }
        .app-layout.sidebar-collapsed {
            grid-template-columns: 0 1fr;
        }

        /* Sidebar (T02, T06) */
        .sidebar {
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid rgba(255,255,255,0.05);
            position: relative;
            z-index: 90;
        }
        .sidebar-header {
            padding: 10px 12px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }
        .sidebar-actions {
            display: flex;
            gap: 6px;
        }
        .btn-sidebar-action {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--sidebar-text);
            border-radius: 3px;
            padding: 5px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background .15s;
            text-align: center;
        }
        .btn-sidebar-action:hover { background: rgba(255,255,255,0.14); }
        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 6px 0;
        }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 2px; }

        /* Repo group (sidebar) */
        .repo-group { margin-bottom: 1px; }
        .repo-group-header {
            display: flex;
            align-items: center;
            padding: 7px 12px;
            cursor: pointer;
            transition: background .1s;
            gap: 6px;
            user-select: none;
        }
        .repo-group-header:hover { background: var(--sidebar-hover); }
        .repo-chevron {
            font-size: 10px;
            color: var(--sidebar-text-muted);
            transition: transform .2s ease;
            flex-shrink: 0;
        }
        .repo-group.open .repo-chevron { transform: rotate(90deg); }
        .repo-name-text {
            font-size: 12px;
            font-weight: 700;
            color: var(--sidebar-text);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }
        .repo-badge {
            background: rgba(255,255,255,0.12);
            color: var(--sidebar-text-muted);
            font-size: 10px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 10px;
            flex-shrink: 0;
        }
        .repo-features { display: none; padding: 0 0 2px 0; }
        .repo-group.open .repo-features { display: block; }

        /* Feature items in sidebar */
        .sidebar-feature-item {
            display: flex;
            align-items: center;
            padding: 6px 12px 6px 26px;
            cursor: pointer;
            transition: background .1s;
            gap: 6px;
            border-left: 3px solid transparent;
        }
        .sidebar-feature-item:hover { background: var(--sidebar-hover); }
        .sidebar-feature-item.active {
            background: var(--sidebar-active);
            border-left-color: var(--sidebar-active-border);
        }
        .sidebar-feature-name {
            font-size: 12px;
            color: var(--sidebar-text);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sidebar-feature-count {
            font-size: 10px;
            color: var(--sidebar-text-muted);
            flex-shrink: 0;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        /* Content header with stats (T06) */
        .content-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .content-header-left { flex: 1; min-width: 0; }
        .feature-headline {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stats-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .stat-item { display: flex; align-items: baseline; gap: 4px; }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); font-weight: 600; }
        .stat-value { font-size: 15px; font-weight: 700; color: var(--text); }
        .stat-value.highlight { color: var(--primary); }
        .progress-track { width: 100px; height: 5px; background: var(--border-light); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width .4s ease; border-radius: 3px; }
        .content-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-input {
            padding: 5px 10px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 13px;
            width: 170px;
            background: var(--bg);
        }
        .search-input:focus { outline: 2px solid var(--primary); outline-offset: -1px; border-color: transparent; }

        /* View toggle */
        .view-toggle { display: flex; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; }
        .view-btn {
            background: transparent;
            border: none;
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background .1s, color .1s;
        }
        .view-btn:hover { background: var(--bg); }
        .view-btn.active { background: var(--primary); color: #fff; }

        /* Board */
        .board-container {
            display: flex;
            overflow-x: auto;
            padding: 14px;
            gap: 8px;
            flex: 1;
            align-items: flex-start;
        }
        .board-column {
            min-width: 235px;
            max-width: 235px;
            background: var(--column-bg);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - var(--topbar-height) - 62px - 28px);
            flex-shrink: 0;
        }
        .column-header {
            padding: 8px 10px 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .column-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .4px;
            color: var(--text-secondary);
        }
        .column-count {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            background: rgba(9,30,66,0.08);
            border-radius: 10px;
            padding: 1px 7px;
        }
        .column-cards { padding: 0 7px 7px; overflow-y: auto; flex: 1; }
        .column-cards::-webkit-scrollbar { width: 4px; }
        .column-cards::-webkit-scrollbar-track { background: transparent; }
        .column-cards::-webkit-scrollbar-thumb { background: rgba(9,30,66,0.13); border-radius: 2px; }
        .board-container::-webkit-scrollbar { height: 6px; }
        .board-container::-webkit-scrollbar-track { background: transparent; }
        .board-container::-webkit-scrollbar-thumb { background: rgba(9,30,66,0.13); border-radius: 3px; }

        /* Task Cards */
        .task-card {
            background: var(--surface);
            border-radius: 3px;
            padding: 9px 9px 7px;
            margin-bottom: 5px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: background .1s, box-shadow .1s;
            border-left: 3px solid transparent;
            position: relative;
        }
        .task-card:hover { background: var(--card-hover); box-shadow: var(--shadow-md); }
        .task-card:hover .task-card-actions { opacity: 1; }
        .task-card:focus { outline: 2px solid var(--primary); outline-offset: 1px; }
        .task-card-actions {
            position: absolute;
            top: 5px; right: 5px;
            display: flex; gap: 3px;
            opacity: 0;
            transition: opacity .15s;
        }
        .task-card-action-btn {
            background: rgba(255,255,255,0.95);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .task-card-action-btn:hover { background: #fff; color: var(--primary); }
        .task-card-action-btn.danger:hover { color: var(--danger); }
        .task-card-id { font-size: 10px; font-weight: 700; color: var(--primary); margin-bottom: 3px; }
        .task-card-title { font-size: 12px; font-weight: 500; color: var(--text); margin-bottom: 5px; word-break: break-word; line-height: 1.35; }
        .task-card-meta { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-muted); margin-bottom: 5px; }
        .task-card-order { background: rgba(9,30,66,0.06); padding: 1px 5px; border-radius: 3px; font-weight: 600; }
        .task-card-deps { font-size: 10px; color: var(--text-muted); margin-bottom: 3px; }
        .task-card-tags { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 4px; }
        .tag-chip { font-size: 10px; padding: 1px 5px; border-radius: 3px; background: rgba(9,30,66,0.06); color: var(--text-secondary); }

        /* Agent Status Badges (T05) */
        .agent-badges { display: flex; gap: 4px; margin-top: 5px; }
        .agent-badge {
            width: 20px; height: 20px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: 800;
            flex-shrink: 0;
            letter-spacing: -0.5px;
        }
        .agent-badge.done { background: #00875a; color: #fff; border: 2px solid #00875a; }
        .agent-badge.pending { background: rgba(0,82,204,0.12); color: var(--primary); border: 2px solid var(--primary); }
        .agent-badge.upcoming { background: transparent; color: var(--text-muted); border: 2px solid var(--border); }
        .agent-badge.needs-refinement { background: #de350b; color: #fff; border: 2px solid #de350b; }
        @keyframes pulse-ring {
            0%   { box-shadow: 0 0 0 0 rgba(0,82,204,0.5); }
            70%  { box-shadow: 0 0 0 4px rgba(0,82,204,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,82,204,0); }
        }
        .agent-badge.pending { animation: pulse-ring 1.8s infinite; }

        /* Reduced motion (T07) */
        @media (prefers-reduced-motion: reduce) {
            .agent-badge.pending { animation: none; }
            .live-dot { animation: none; }
            *, *::before, *::after { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; }
        }

        /* Status left-border colors */
        .border-PendingProductDirector { border-left-color: #b3bac5; }
        .border-PendingArchitect { border-left-color: #998dd9; }
        .border-PendingUiUxExpert { border-left-color: #79b8ff; }
        .border-PendingSecurityOfficer { border-left-color: #a78bfa; }
        .border-ReadyForDevelopment { border-left-color: #57d9a3; }
        .border-NeedsRefinement { border-left-color: #f87171; }
        .border-ToDo { border-left-color: #93c5fd; }
        .border-InProgress { border-left-color: #0065ff; }
        .border-InReview { border-left-color: #f59e0b; }
        .border-InQA { border-left-color: #a855f7; }
        .border-NeedsChanges { border-left-color: #ef4444; }
        .border-Done { border-left-color: #22c55e; }

        /* Feature Detail Panel (T04) */
        .detail-panel { flex: 1; overflow-y: auto; padding: 20px; }
        .detail-panel-header { margin-bottom: 20px; padding-bottom: 14px; border-bottom: 2px solid var(--border); }
        .detail-panel-header h2 { font-size: 19px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .detail-panel-slug { font-size: 12px; color: var(--text-muted); font-family: monospace; }
        .detail-panel-meta { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
        .detail-meta-item { font-size: 12px; color: var(--text-secondary); }
        .detail-meta-item strong { color: var(--text); }
        .detail-section { margin-bottom: 22px; }
        .detail-section-title {
            font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: .7px;
            color: var(--text-muted); margin-bottom: 10px; padding-bottom: 6px;
            border-bottom: 1px solid var(--border-light);
            display: flex; align-items: center; gap: 6px;
        }
        .detail-section-count {
            background: var(--border-light); color: var(--text-muted);
            font-size: 10px; padding: 1px 6px; border-radius: 10px;
        }
        .priority-badge {
            display: inline-block; font-size: 10px; font-weight: 700;
            padding: 1px 6px; border-radius: 3px; text-transform: uppercase; letter-spacing: .2px; flex-shrink: 0;
        }
        .priority-must { background: #fff0ee; color: #de350b; }
        .priority-should { background: #fff8e6; color: #7a4500; }
        .priority-could { background: #e6f7ee; color: #00623a; }
        .priority-p0 { background: #f4e8ff; color: #6b21a8; }
        .priority-p1 { background: #e4f0ff; color: #0052cc; }
        .priority-p2 { background: #f4f5f7; color: #5e6c84; }
        .priority-p3 { background: #f4f5f7; color: #97a0af; }
        .ac-list { list-style: none; }
        .ac-item {
            display: flex; align-items: flex-start; gap: 8px;
            padding: 7px 0; border-bottom: 1px solid var(--border-light); font-size: 13px;
        }
        .ac-item:last-child { border-bottom: none; }
        .ac-verified { color: #00875a; font-size: 14px; flex-shrink: 0; }
        .ac-unverified { color: var(--border); font-size: 14px; flex-shrink: 0; }
        .scenario-list { list-style: none; }
        .scenario-item { padding: 8px 10px; border: 1px solid var(--border-light); border-radius: 4px; margin-bottom: 6px; background: var(--bg); }
        .scenario-item-header { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .scenario-title { font-size: 12px; font-weight: 600; color: var(--text); }
        .scenario-desc { font-size: 12px; color: var(--text-secondary); }
        .steps-list { list-style: none; }
        .step-item { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid var(--border-light); font-size: 13px; }
        .step-item:last-child { border-bottom: none; }
        .step-number {
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; flex-shrink: 0;
        }
        .step-number.complete { background: #00875a; color: #fff; }
        .step-number.incomplete { background: var(--border-light); color: var(--text-muted); }
        .task-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .task-table th {
            text-align: left; padding: 6px 8px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: .4px; color: var(--text-muted);
            border-bottom: 2px solid var(--border);
        }
        .task-table td { padding: 7px 8px; border-bottom: 1px solid var(--border-light); color: var(--text); }
        .task-table tr:nth-child(even) td { background: var(--bg); }
        .task-table tr:last-child td { border-bottom: none; }
        .empty-state-msg { text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px; }

        /* Task Detail Modal sections */
        .tdetail-section { margin-bottom: 14px; }
        .tdetail-section-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: .5px; color: var(--text-muted);
            margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border-light);
        }
        .tdetail-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
        .tdetail-label { color: var(--text-secondary); }
        .tdetail-value { font-weight: 500; color: var(--text); text-align: right; max-width: 60%; }
        .status-badge {
            display: inline-block; font-size: 11px; font-weight: 600;
            padding: 2px 8px; border-radius: 3px; text-transform: uppercase; letter-spacing: .3px;
        }
        .badge-pending { background: #f0f0f0; color: #666; }
        .badge-review { background: #fff3cd; color: #856404; }
        .badge-active { background: #cce5ff; color: #004085; }
        .badge-done { background: #d4edda; color: #155724; }
        .badge-blocked { background: #f8d7da; color: #721c24; }
        .transition-list { list-style: none; }
        .transition-item { padding: 6px 0; border-bottom: 1px solid var(--border-light); font-size: 12px; }
        .transition-item:last-child { border-bottom: none; }
        .transition-arrow { color: var(--text-muted); margin: 0 4px; }
        .transition-time { color: var(--text-muted); font-size: 11px; display: block; }
        .criteria-list { list-style: none; }
        .criteria-item { padding: 4px 0; font-size: 12px; display: flex; align-items: flex-start; gap: 6px; }
        .criteria-check { flex-shrink: 0; font-size: 13px; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 12px; border: none; border-radius: 3px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            white-space: nowrap; transition: background .15s;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-subtle { background: transparent; color: var(--text-secondary); }
        .btn-subtle:hover { background: rgba(9,30,66,0.06); }
        .btn-danger-solid { background: var(--danger); color: #fff; border: none; }
        .btn-danger-solid:hover { background: var(--danger-hover); }
        .btn:disabled { opacity: .4; cursor: not-allowed; pointer-events: none; }

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(9,30,66,0.54); z-index: 200;
            justify-content: center; align-items: flex-start;
            padding-top: 60px; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--surface); border-radius: 4px;
            width: 520px; max-width: 95vw;
            box-shadow: 0 8px 24px rgba(9,30,66,0.28); margin-bottom: 40px;
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px 12px; border-bottom: 1px solid var(--border-light);
        }
        .modal-header h3 { font-size: 15px; font-weight: 700; color: var(--text); }
        .modal-close {
            background: none; border: none; font-size: 18px;
            color: var(--text-muted); cursor: pointer;
            padding: 4px 8px; border-radius: 3px; line-height: 1;
        }
        .modal-close:hover { background: rgba(9,30,66,0.06); }
        .modal-body { padding: 14px 18px; }
        .modal-footer { padding: 10px 18px 14px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid var(--border-light); }
        .field { margin-bottom: 12px; }
        .field label {
            display: flex; align-items: center; gap: 4px;
            font-size: 12px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px;
        }
        .field label .req { color: var(--danger); }
        .field input, .field select, .field textarea {
            width: 100%; padding: 7px 10px; border: 1px solid var(--border);
            border-radius: 3px; font-size: 13px; font-family: inherit; color: var(--text); background: #fff;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            outline: 2px solid var(--primary); outline-offset: -1px; border-color: transparent;
        }
        .field textarea { resize: vertical; min-height: 70px; }
        .field-hint { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
        .form-error { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; }

        /* Empty / Loading */
        .empty-board { display: flex; align-items: center; justify-content: center; flex: 1; }
        .empty-board-inner { text-align: center; max-width: 360px; }
        .empty-board-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.35; }
        .empty-board-inner h3 { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .empty-board-inner p { font-size: 13px; color: var(--text-muted); }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 10px 16px; border-radius: 4px;
            font-size: 13px; font-weight: 500;
            box-shadow: var(--shadow-md); z-index: 400;
            transition: opacity .3s, transform .3s;
            opacity: 0; transform: translateY(10px);
            max-width: 360px; pointer-events: none;
        }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast-error { background: var(--danger); color: #fff; }
        .toast-success { background: var(--success); color: #fff; }

        /* Responsive (T07): collapse sidebar below 1280px */
        @media (max-width: 1279px) {
            .app-layout { grid-template-columns: 0 1fr !important; }
            .sidebar {
                position: fixed; top: var(--topbar-height); left: 0; bottom: 0;
                width: var(--sidebar-width); z-index: 150;
                transform: translateX(-100%); transition: transform .2s ease;
            }
            .app-layout.sidebar-open .sidebar {
                transform: translateX(0);
                box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            }
            .sidebar-overlay { display: none; position: fixed; inset: 0; top: var(--topbar-height); background: rgba(0,0,0,0.3); z-index: 149; }
            .app-layout.sidebar-open .sidebar-overlay { display: block; }
        }
        @media (min-width: 1280px) {
            .sidebar-overlay { display: none !important; }
        }

        /* Screen reader only */
        .sr-only { position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }
    </style>
</head>
<body>

<a href="#main-content" class="skip-link">Skip to main content</a>
<div class="sr-only" aria-live="polite" aria-atomic="true" id="ariaLive"></div>

<!-- Topbar (T06) -->
<header class="topbar" role="banner">
    <button class="sidebar-toggle" id="sidebarToggle"
            aria-label="Toggle sidebar navigation" aria-expanded="true" aria-controls="sidebar">&#9776;</button>
    <span class="topbar-brand">&#10097;&#10097; <span>Agent</span> Orchestration Console</span>
    <div class="topbar-right">
        <div class="live-dot active" id="liveDot" aria-hidden="true"></div>
        <span class="topbar-label" id="refreshLabel">Auto-refresh 5s</span>
        <button class="btn-icon" id="refreshToggle" aria-label="Toggle auto-refresh" aria-pressed="true" title="Toggle auto-refresh">&#8635;</button>
    </div>
</header>

<!-- App Layout -->
<div class="app-layout sidebar-open" id="appLayout">

    <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

    <!-- Sidebar (T02) -->
    <nav class="sidebar" id="sidebar" role="navigation" aria-label="Repository navigation">
        <div class="sidebar-header">
            <div class="sidebar-actions">
                <button class="btn-sidebar-action" onclick="openModal('repoModal')" aria-label="Register a new repository">+ Repo</button>
                <button class="btn-sidebar-action" onclick="openModal('featureModal')" aria-label="Create a new feature">+ Feature</button>
            </div>
        </div>
        <div class="sidebar-scroll" role="tree" aria-label="Repositories and features">
            <div id="repoTree">
                <div style="padding:20px 12px;color:var(--sidebar-text-muted);font-size:12px;text-align:center;">Loading...</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content" role="main">

        <!-- Content header with stats (T06) -->
        <div class="content-header" id="contentHeader" style="display:none;">
            <div class="content-header-left">
                <div class="feature-headline" id="featureHeadline"></div>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-label">Total</span>
                        <span class="stat-value" id="statTotal">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Done</span>
                        <span class="stat-value highlight" id="statDone">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">In Flight</span>
                        <span class="stat-value" id="statInFlight">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Blocked</span>
                        <span class="stat-value" id="statBlocked">0</span>
                    </div>
                    <div class="stat-item">
                        <div class="progress-track" role="progressbar" id="progressTrack"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Completion progress">
                            <div class="progress-fill" id="progressFill" style="width:0%"></div>
                        </div>
                        <span class="stat-value" id="statPercent" style="font-size:13px;margin-left:6px;">0%</span>
                    </div>
                </div>
            </div>
            <div class="content-header-right">
                <input type="search" class="search-input" id="searchInput"
                       placeholder="Filter tasks..." aria-label="Filter tasks by ID or title">
                <button class="btn btn-subtle" id="deleteFeatureBtn" onclick="deleteFeature()"
                        style="display:none;color:var(--danger);" aria-label="Delete current feature">&#128465; Delete</button>
                <div class="view-toggle" role="group" aria-label="View mode">
                    <button class="view-btn active" id="viewBoardBtn" onclick="setView('board')" aria-pressed="true">Board</button>
                    <button class="view-btn" id="viewDetailBtn" onclick="setView('detail')" aria-pressed="false">Details</button>
                </div>
            </div>
        </div>

        <!-- Board view -->
        <div id="boardView" style="display:none;flex:1;overflow:hidden;">
            <div class="board-container" id="board" role="region" aria-label="Task board" style="height:100%;"></div>
        </div>

        <!-- Feature detail panel (T04) -->
        <div id="detailView" style="display:none;flex:1;overflow:hidden;">
            <div class="detail-panel" id="detailPanelContent" role="region" aria-label="Feature details"></div>
        </div>

        <!-- Empty state -->
        <div class="empty-board" id="emptyState" style="flex:1;">
            <div class="empty-board-inner">
                <div class="empty-board-icon">&#9688;</div>
                <h3>No feature selected</h3>
                <p>Select a repository and feature from the sidebar to view the orchestration board.</p>
            </div>
        </div>

    </main>
</div>

<!-- Register Repo Modal (T03) -->
<div class="modal-overlay" id="repoModal" role="dialog" aria-modal="true" aria-labelledby="repoModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h3 id="repoModalTitle">Register Repository</h3>
            <button class="modal-close" onclick="closeModal('repoModal')" aria-label="Close">&#10005;</button>
        </div>
        <form onsubmit="registerRepo(event)" novalidate>
            <div class="modal-body">
                <div class="field">
                    <label for="repoNameInput">Repo Name <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="repoNameInput" required placeholder="my-repo"
                           pattern="^[a-z0-9][a-z0-9\-]*[a-z0-9]$|^[a-z0-9]$"
                           autocomplete="off" aria-required="true" aria-describedby="repoNameHint">
                    <div class="field-hint" id="repoNameHint">Lowercase letters, numbers, hyphens. No leading/trailing hyphens.</div>
                </div>
                <div class="field">
                    <label for="repoPathInput">Repo Path <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="repoPathInput" required placeholder="/home/user/my-repo"
                           autocomplete="off" aria-required="true">
                </div>
                <div class="field">
                    <label for="repoUrlInput">Repo URL <span style="font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></label>
                    <input type="url" id="repoUrlInput" placeholder="https://github.com/org/my-repo" autocomplete="off">
                </div>
                <div class="field">
                    <label for="repoBranchInput">Default Branch <span style="font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></label>
                    <input type="text" id="repoBranchInput" value="main" placeholder="main" autocomplete="off">
                </div>
                <div class="form-error" id="repoFormError" role="alert" aria-live="assertive"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-subtle" onclick="closeModal('repoModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Register</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Feature Modal -->
<div class="modal-overlay" id="featureModal" role="dialog" aria-modal="true" aria-labelledby="featureModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h3 id="featureModalTitle">Create Feature</h3>
            <button class="modal-close" onclick="closeModal('featureModal')" aria-label="Close">&#10005;</button>
        </div>
        <form onsubmit="createFeature(event)">
            <div class="modal-body">
                <div class="field">
                    <label for="newFeatureSlug">Feature Slug <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="newFeatureSlug" required placeholder="my-feature" pattern="[a-z0-9-]+" aria-required="true">
                </div>
                <div class="field">
                    <label for="newFeatureName">Feature Name <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="newFeatureName" required placeholder="My Feature" aria-required="true">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-subtle" onclick="closeModal('featureModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal-overlay" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
    <div class="modal">
        <div class="modal-header">
            <h3 id="taskModalTitle">Add Task</h3>
            <button class="modal-close" onclick="closeModal('taskModal')" aria-label="Close">&#10005;</button>
        </div>
        <form onsubmit="addTask(event)">
            <div class="modal-body">
                <div class="field">
                    <label for="newTaskId">Task ID <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="newTaskId" required placeholder="T01" pattern="T[0-9]+" aria-required="true">
                </div>
                <div class="field">
                    <label for="newTaskTitle">Title <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="newTaskTitle" required placeholder="Implement authentication" aria-required="true">
                </div>
                <div class="field">
                    <label for="newTaskDescription">Description</label>
                    <textarea id="newTaskDescription" placeholder="Task description..."></textarea>
                </div>
                <div style="display:flex;gap:10px;">
                    <div class="field" style="flex:1;">
                        <label for="newTaskStatus">Status <span class="req" aria-hidden="true">*</span></label>
                        <select id="newTaskStatus" required aria-required="true">
                            <option value="PendingProductDirector">Pending Product Director</option>
                            <option value="PendingArchitect">Pending Architect</option>
                            <option value="PendingUiUxExpert">Pending UI/UX Expert</option>
                            <option value="PendingSecurityOfficer">Pending Security Officer</option>
                            <option value="ReadyForDevelopment">Ready For Development</option>
                            <option value="NeedsRefinement">Needs Refinement</option>
                            <option value="ToDo">To Do</option>
                            <option value="InProgress">In Progress</option>
                            <option value="InReview">In Review</option>
                            <option value="InQA">In QA</option>
                            <option value="NeedsChanges">Needs Changes</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                    <div class="field" style="width:85px;">
                        <label for="newTaskOrder">Order <span class="req" aria-hidden="true">*</span></label>
                        <input type="number" id="newTaskOrder" required value="1" min="0" aria-required="true">
                    </div>
                    <div class="field" style="width:85px;">
                        <label for="newTaskHours">Est. Hrs</label>
                        <input type="number" id="newTaskHours" min="0" step="0.5" placeholder="--">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-subtle" onclick="closeModal('taskModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Task</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal-overlay" id="editTaskModal" role="dialog" aria-modal="true" aria-labelledby="editTaskModalTitle">
    <div class="modal" style="width:600px;max-height:85vh;overflow-y:auto;">
        <div class="modal-header">
            <h3 id="editTaskModalTitle">Edit Task <span id="editTaskIdLabel"></span></h3>
            <button class="modal-close" onclick="closeModal('editTaskModal')" aria-label="Close">&#10005;</button>
        </div>
        <form onsubmit="saveTaskEdits(event)">
            <div class="modal-body">
                <div class="field">
                    <label for="editTaskTitle">Title <span class="req" aria-hidden="true">*</span></label>
                    <input type="text" id="editTaskTitle" required aria-required="true">
                </div>
                <div class="field">
                    <label for="editTaskDescription">Description</label>
                    <textarea id="editTaskDescription" rows="3"></textarea>
                </div>
                <div style="display:flex;gap:10px;">
                    <div class="field" style="flex:1;">
                        <label for="editTaskOrder">Order of Execution <span class="req" aria-hidden="true">*</span></label>
                        <input type="number" id="editTaskOrder" required min="0" aria-required="true">
                    </div>
                    <div class="field" style="flex:1;">
                        <label for="editTaskHours">Estimated Hours</label>
                        <input type="number" id="editTaskHours" min="0" step="0.5" placeholder="--">
                    </div>
                </div>
                <div class="field">
                    <label for="editTaskTags">Tags (comma-separated)</label>
                    <input type="text" id="editTaskTags" placeholder="frontend, api">
                </div>
                <div class="field">
                    <label for="editTaskDependencies">Dependencies (comma-separated task IDs)</label>
                    <input type="text" id="editTaskDependencies" placeholder="T01, T02">
                </div>
                <div class="field">
                    <label for="editTaskOutOfScope">Out of Scope (one per line)</label>
                    <textarea id="editTaskOutOfScope" rows="2" placeholder="Item 1&#10;Item 2"></textarea>
                </div>
                <div class="field">
                    <label>Acceptance Criteria</label>
                    <div id="editAcceptanceCriteriaList"></div>
                    <button type="button" class="btn btn-subtle" style="margin-top:6px;font-size:12px;" onclick="addCriterionRow()">+ Add Criterion</button>
                </div>
                <div class="field">
                    <label>Test Scenarios</label>
                    <div id="editTestScenariosList"></div>
                    <button type="button" class="btn btn-subtle" style="margin-top:6px;font-size:12px;" onclick="addScenarioRow()">+ Add Scenario</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-subtle" onclick="closeModal('editTaskModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal-overlay" id="deleteTaskModal" role="dialog" aria-modal="true" aria-labelledby="deleteTaskModalTitle">
    <div class="modal" style="width:420px;">
        <div class="modal-header">
            <h3 id="deleteTaskModalTitle">Delete Task</h3>
            <button class="modal-close" onclick="closeModal('deleteTaskModal')" aria-label="Close">&#10005;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:10px;">Are you sure you want to delete task <strong id="deleteTaskId"></strong>: <strong id="deleteTaskTitle"></strong>?</p>
            <p style="font-size:12px;color:var(--text-secondary);">This removes all associated data and cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-subtle" onclick="closeModal('deleteTaskModal')">Cancel</button>
            <button class="btn btn-danger-solid" onclick="confirmDeleteTask()">Delete Task</button>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal-overlay" id="detailModal" role="dialog" aria-modal="true" aria-labelledby="detailModalTitle">
    <div class="modal" style="width:620px;max-height:85vh;overflow-y:auto;">
        <div class="modal-header">
            <h3 id="detailModalTitle">Task Detail</h3>
            <button class="modal-close" onclick="closeModal('detailModal')" aria-label="Close">&#10005;</button>
        </div>
        <div class="modal-body" id="detailBody"></div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
// ── State ──
let currentRepo = '';
let currentSlug = '';
let allTasks = [];
let allRepos = [];
let summaryData = null;
let autoRefreshEnabled = true;
let autoRefreshTimer = null;
let searchTerm = '';
let currentView = 'board';
let featureDetailCache = {};

// ── Status columns ──
const STATUS_COLUMNS = [
    { key: 'PendingProductDirector', label: 'Pending PD' },
    { key: 'PendingArchitect',       label: 'Pending Architect' },
    { key: 'PendingUiUxExpert',      label: 'Pending UI/UX' },
    { key: 'PendingSecurityOfficer', label: 'Pending Security' },
    { key: 'NeedsRefinement',        label: 'Needs Refinement' },
    { key: 'ReadyForDevelopment',    label: 'Ready for Dev' },
    { key: 'ToDo',                   label: 'To Do' },
    { key: 'InProgress',             label: 'In Progress' },
    { key: 'InReview',               label: 'In Review' },
    { key: 'InQA',                   label: 'In QA' },
    { key: 'NeedsChanges',           label: 'Needs Changes' },
    { key: 'Done',                   label: 'Done' },
];

// Agent badges pipeline (T05)
const REVIEW_PIPELINE = ['PendingProductDirector','PendingArchitect','PendingUiUxExpert','PendingSecurityOfficer'];
const BADGE_META = [
    { key: 'productDirector', initials: 'PD', label: 'Product Director' },
    { key: 'architect',       initials: 'AR', label: 'Architect' },
    { key: 'uiUxExpert',      initials: 'UX', label: 'UI/UX Expert' },
    { key: 'securityOfficer', initials: 'SE', label: 'Security Officer' },
];
const REVIEW_COMPLETE_STATUSES = new Set([
    'ReadyForDevelopment','ToDo','InProgress','InReview','InQA','NeedsChanges','Done'
]);

// ── Init ──
document.addEventListener('DOMContentLoaded', () => {
    setupSidebarToggle();
    setupAutoRefresh();
    loadRepos();
    document.getElementById('searchInput').addEventListener('input', e => {
        searchTerm = e.target.value.toLowerCase();
        renderBoard();
    });
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            if (window.innerWidth < 1280) closeSidebar();
        }
    });
    document.addEventListener('click', e => {
        if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('active')) {
            e.target.classList.remove('active');
        }
    });
});

// ── Sidebar toggle (T02, T07) ──
function setupSidebarToggle() {
    const btn = document.getElementById('sidebarToggle');
    const layout = document.getElementById('appLayout');
    document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
    btn.addEventListener('click', () => {
        const open = layout.classList.contains('sidebar-open');
        if (open) closeSidebar();
        else { layout.classList.add('sidebar-open'); btn.setAttribute('aria-expanded','true'); }
    });
}
function closeSidebar() {
    document.getElementById('appLayout').classList.remove('sidebar-open');
    document.getElementById('sidebarToggle').setAttribute('aria-expanded','false');
}

// ── Auto-refresh (T06) ──
function setupAutoRefresh() {
    const btn = document.getElementById('refreshToggle');
    btn.addEventListener('click', () => {
        autoRefreshEnabled = !autoRefreshEnabled;
        btn.setAttribute('aria-pressed', String(autoRefreshEnabled));
        document.getElementById('liveDot').classList.toggle('active', autoRefreshEnabled);
        document.getElementById('refreshLabel').textContent = autoRefreshEnabled ? 'Auto-refresh 5s' : 'Auto-refresh off';
        if (autoRefreshEnabled && currentSlug) scheduleAutoRefresh();
        else { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
    });
}
function scheduleAutoRefresh() {
    clearInterval(autoRefreshTimer);
    if (autoRefreshEnabled && currentSlug)
        autoRefreshTimer = setInterval(() => loadBoard(currentSlug), 5000);
}

function announce(msg) {
    const el = document.getElementById('ariaLive');
    el.textContent = '';
    requestAnimationFrame(() => { el.textContent = msg; });
}

// ── Repos & Features ──
async function loadRepos() {
    try {
        const res = await fetch('/api/repos');
        const data = await res.json();
        allRepos = data.repos || [];
        await Promise.all(allRepos.map(async r => {
            try {
                const fr = await fetch(`/api/features?repoName=${encodeURIComponent(r.repoName)}`);
                const fd = await fr.json();
                r._features = fd.features || [];
            } catch { r._features = []; }
        }));
        renderRepoTree();
    } catch {
        document.getElementById('repoTree').innerHTML =
            '<div style="padding:16px 12px;color:#f87171;font-size:12px;">Failed to load repos</div>';
    }
}

// ── Render sidebar repo tree (T02) ──
function renderRepoTree() {
    const tree = document.getElementById('repoTree');
    if (!allRepos.length) {
        tree.innerHTML = '<div style="padding:20px 12px;color:var(--sidebar-text-muted);font-size:12px;text-align:center;">No repos registered.<br>Click + Repo to add one.</div>';
        return;
    }
    tree.innerHTML = allRepos.map(repo => {
        const features = repo._features || [];
        const isOpen = repo.repoName === currentRepo;
        return `
        <div class="repo-group ${isOpen?'open':''}" data-repo="${esc(repo.repoName)}">
            <div class="repo-group-header"
                 role="treeitem" tabindex="0"
                 aria-expanded="${isOpen}"
                 onclick="selectRepo('${esc(repo.repoName)}')"
                 onkeydown="treeKey(event,'repo','${esc(repo.repoName)}')"
                 title="${esc(repo.repoName)}">
                <span class="repo-chevron" aria-hidden="true">&#9658;</span>
                <span class="repo-name-text">${esc(repo.repoName)}</span>
                <span class="repo-badge" aria-label="${features.length} features">${features.length}</span>
            </div>
            <div class="repo-features" role="group" aria-label="${esc(repo.repoName)} features">
                ${features.length === 0
                    ? '<div style="padding:5px 12px 5px 26px;font-size:11px;color:var(--sidebar-text-muted);">No features</div>'
                    : features.map(f => `
                    <div class="sidebar-feature-item ${f.featureSlug===currentSlug?'active':''}"
                         role="treeitem" tabindex="${isOpen?'0':'-1'}"
                         ${f.featureSlug===currentSlug?'aria-current="page"':''}
                         onclick="selectFeature('${esc(repo.repoName)}','${esc(f.featureSlug)}')"
                         onkeydown="treeKey(event,'feature','${esc(repo.repoName)}','${esc(f.featureSlug)}')"
                         title="${esc(f.featureName)}">
                        <span class="sidebar-feature-name">${esc(f.featureName)}</span>
                        <span class="sidebar-feature-count" aria-label="${f.totalTasks} tasks">${f.totalTasks}</span>
                    </div>`).join('')}
            </div>
        </div>`;
    }).join('');
}

function treeKey(e, type, repo, slug) {
    if (e.key==='Enter'||e.key===' ') { e.preventDefault(); type==='repo' ? selectRepo(repo) : selectFeature(repo,slug); }
}

function selectRepo(repoName) {
    if (currentRepo === repoName) {
        const g = document.querySelector(`.repo-group[data-repo="${repoName}"]`);
        if (g) g.classList.toggle('open');
    } else {
        currentRepo = repoName;
        renderRepoTree();
    }
}

async function selectFeature(repoName, slug) {
    currentRepo = repoName;
    currentView = 'board';
    await loadBoard(slug);
    if (window.innerWidth < 1280) closeSidebar();
}

// ── Board Loading ──
async function loadBoard(slug) {
    currentSlug = slug;
    try {
        const res = await fetch(`/api/tasks?featureSlug=${encodeURIComponent(slug)}&repoName=${encodeURIComponent(currentRepo)}`);
        if (!res.ok) {
            const err = await res.json().catch(()=>({}));
            if (res.status===404) {
                clearInterval(autoRefreshTimer); autoRefreshTimer=null;
                currentSlug=''; allTasks=[]; summaryData=null;
                showEmptyState();
                showToast('Feature "'+slug+'" not found.','error');
                return;
            }
            throw new Error(err.error||'Failed to load');
        }
        summaryData = await res.json();
        allTasks = summaryData.tasks || [];
        updateStats();
        renderBoard();
        renderRepoTree();
        document.getElementById('contentHeader').style.display='flex';
        document.getElementById('emptyState').style.display='none';
        document.getElementById('deleteFeatureBtn').style.display='inline-flex';
        const feat = (allRepos.find(r=>r.repoName===currentRepo)?._features||[]).find(f=>f.featureSlug===slug);
        document.getElementById('featureHeadline').textContent = feat ? feat.featureName : slug;
        setView(currentView);
        scheduleAutoRefresh();
    } catch(e) { showToast(e.message,'error'); }
}

function showEmptyState() {
    document.getElementById('contentHeader').style.display='none';
    document.getElementById('boardView').style.display='none';
    document.getElementById('detailView').style.display='none';
    document.getElementById('emptyState').style.display='flex';
    document.getElementById('deleteFeatureBtn').style.display='none';
    clearInterval(autoRefreshTimer); autoRefreshTimer=null;
}

// ── View Toggle (T02, T04) ──
function setView(view) {
    currentView = view;
    const bv = document.getElementById('boardView');
    const dv = document.getElementById('detailView');
    const bb = document.getElementById('viewBoardBtn');
    const db = document.getElementById('viewDetailBtn');
    if (view==='board') {
        bv.style.display='flex'; dv.style.display='none';
        bb.classList.add('active'); db.classList.remove('active');
        bb.setAttribute('aria-pressed','true'); db.setAttribute('aria-pressed','false');
    } else {
        bv.style.display='none'; dv.style.display='flex';
        bb.classList.remove('active'); db.classList.add('active');
        bb.setAttribute('aria-pressed','false'); db.setAttribute('aria-pressed','true');
        loadFeatureDetail();
    }
}

// ── Stats (T06) ──
function updateStats() {
    if (!summaryData) return;
    const by = summaryData.tasksByStatus || {};
    document.getElementById('statTotal').textContent = summaryData.totalTasks||0;
    document.getElementById('statDone').textContent = by.Done||0;
    document.getElementById('statInFlight').textContent = (by.InProgress||0)+(by.InReview||0)+(by.InQA||0);
    document.getElementById('statBlocked').textContent = (by.NeedsChanges||0)+(by.NeedsRefinement||0);
    const pct = (summaryData.totalTasks||0)>0 ? Math.round(((by.Done||0)/summaryData.totalTasks)*100) : 0;
    document.getElementById('statPercent').textContent = pct+'%';
    document.getElementById('progressFill').style.width = pct+'%';
    const pt = document.getElementById('progressTrack');
    pt.setAttribute('aria-valuenow',pct);
    pt.setAttribute('aria-label',pct+'% tasks complete');
}

// ── Board Rendering ──
function renderBoard() {
    const board = document.getElementById('board');
    const buckets = {};
    STATUS_COLUMNS.forEach(c => { buckets[c.key] = []; });
    const filtered = allTasks.filter(t => !searchTerm || t.taskId.toLowerCase().includes(searchTerm) || (t.title||'').toLowerCase().includes(searchTerm));
    filtered.sort((a,b) => a.orderOfExecution-b.orderOfExecution);
    filtered.forEach(t => { if (buckets[t.status]) buckets[t.status].push(t); });
    const active = STATUS_COLUMNS.filter(c => buckets[c.key].length > 0);
    if (allTasks.length > 0) {
        ['ToDo','InProgress','InReview','Done'].forEach(s => {
            if (!active.find(c=>c.key===s)) { const col=STATUS_COLUMNS.find(c=>c.key===s); if(col) active.push(col); }
        });
    }
    active.sort((a,b) => STATUS_COLUMNS.findIndex(c=>c.key===a.key)-STATUS_COLUMNS.findIndex(c=>c.key===b.key));
    board.innerHTML = active.map(col => `
        <div class="board-column" role="group" aria-label="${col.label} column">
            <div class="column-header">
                <span class="column-title">${col.label}</span>
                <span class="column-count" aria-label="${buckets[col.key].length} tasks">${buckets[col.key].length}</span>
            </div>
            <div class="column-cards">${buckets[col.key].map(t => renderCard(t)).join('')}</div>
        </div>`).join('');
}

// ── Agent Badges (T05) ──
function getBadgeState(task, i) {
    const s = task.status;
    if (s==='NeedsRefinement') return 'needs-refinement';
    if (REVIEW_COMPLETE_STATUSES.has(s)) return 'done';
    const pi = REVIEW_PIPELINE.indexOf(s);
    if (pi===-1) return 'upcoming';
    if (i<pi) return 'done';
    if (i===pi) return 'pending';
    return 'upcoming';
}
function renderAgentBadges(task) {
    return '<div class="agent-badges" aria-label="Agent review pipeline">' +
        BADGE_META.map((b,i) => {
            const state = getBadgeState(task, i);
            const stateLabel = state==='done'?'Approved': state==='pending'?'Current reviewer': state==='needs-refinement'?'Needs refinement':'Upcoming';
            return `<div class="agent-badge ${state}" title="${esc(b.label)}: ${stateLabel}" aria-label="${esc(b.label)}: ${stateLabel}">${esc(b.initials)}</div>`;
        }).join('') + '</div>';
}

function renderCard(task) {
    const dep = task.dependencies&&task.dependencies.length ? `<div class="task-card-deps">Deps: ${task.dependencies.join(', ')}</div>` : '';
    const tags = task.tags&&task.tags.length ? `<div class="task-card-tags">${task.tags.map(t=>`<span class="tag-chip">${esc(t)}</span>`).join('')}</div>` : '';
    return `
    <div class="task-card border-${task.status}" tabindex="0" role="article"
         aria-label="${esc(task.taskId)}: ${esc(task.title)}"
         onclick="showTaskDetail('${task.taskId}')"
         onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showTaskDetail('${task.taskId}')}">
        <div class="task-card-actions" aria-hidden="true">
            <button class="task-card-action-btn" onclick="event.stopPropagation();editTask('${task.taskId}')" title="Edit">&#9998;</button>
            <button class="task-card-action-btn danger" onclick="event.stopPropagation();deleteTaskPrompt('${task.taskId}')" title="Delete">&#128465;</button>
        </div>
        <div class="task-card-id">${esc(task.taskId)}</div>
        <div class="task-card-title">${esc(task.title)}</div>
        <div class="task-card-meta">
            <span class="task-card-order" aria-label="Order ${task.orderOfExecution}">#${task.orderOfExecution}</span>
            ${task.estimatedHours?`<span>${task.estimatedHours}h</span>`:''}
        </div>
        ${dep}${tags}
        ${renderAgentBadges(task)}
    </div>`;
}

// ── Feature Detail Panel (T04) ──
async function loadFeatureDetail() {
    const panel = document.getElementById('detailPanelContent');
    if (!currentSlug) { panel.innerHTML='<div class="empty-state-msg">No feature selected.</div>'; return; }
    const key = currentRepo+'::'+currentSlug;
    if (featureDetailCache[key]) { renderFeatureDetail(featureDetailCache[key]); return; }
    panel.innerHTML = '<div class="empty-state-msg">Loading feature details...</div>';
    try {
        const res = await fetch(`/api/features/${encodeURIComponent(currentSlug)}/details?repoName=${encodeURIComponent(currentRepo)}`);
        if (!res.ok) throw new Error('Failed to load feature details');
        const data = await res.json();
        featureDetailCache[key] = data;
        renderFeatureDetail(data);
    } catch(e) { panel.innerHTML=`<div class="empty-state-msg" style="color:var(--danger);">${esc(e.message)}</div>`; }
}

function renderFeatureDetail(data) {
    const panel = document.getElementById('detailPanelContent');
    const feat = data.feature || {};
    const ac = data.acceptanceCriteria || [];
    const ts = data.testScenarios || [];
    const steps = data.refinementSteps || [];
    const clarifications = data.clarifications || [];
    const rs = data.refinementStatus || {};
    const completedSteps = rs.completedSteps || 0;
    const totalSteps = rs.totalSteps || 8;

    let h = `<div class="detail-panel-header">
        <h2>${esc(feat.featureName||currentSlug)}</h2>
        <div class="detail-panel-slug">${esc(feat.featureSlug||currentSlug)}</div>
        <div class="detail-panel-meta">
            ${feat.totalTasks!=null?`<div class="detail-meta-item"><strong>${feat.totalTasks}</strong> tasks</div>`:''}
            ${feat.lastModified?`<div class="detail-meta-item">Modified: <strong>${new Date(feat.lastModified).toLocaleDateString()}</strong></div>`:''}
            ${rs.progressPercentage!=null?`<div class="detail-meta-item">Refinement: <strong>${rs.progressPercentage}%</strong></div>`:''}
        </div></div>`;

    // AC
    h += `<div class="detail-section"><div class="detail-section-title">&#10003; Acceptance Criteria <span class="detail-section-count">${ac.length}</span></div>`;
    if (!ac.length) { h += '<div class="empty-state-msg">No feature-level acceptance criteria.</div>'; }
    else {
        h += '<ul class="ac-list" aria-label="Acceptance criteria">';
        ac.forEach(item => {
            const pc = item.priority==='Must Have'?'priority-must':item.priority==='Should Have'?'priority-should':'priority-could';
            h += `<li class="ac-item">
                <span class="${item.verified?'ac-verified':'ac-unverified'}" aria-label="${item.verified?'Verified':'Not verified'}">${item.verified?'&#10004;':'&#9675;'}</span>
                <span class="priority-badge ${pc}">${esc(item.priority||'')}</span>
                <span>${esc(item.criterion||'')}</span></li>`;
        });
        h += '</ul>';
    }
    h += '</div>';

    // Test Scenarios
    h += `<div class="detail-section"><div class="detail-section-title">&#9654; Test Scenarios <span class="detail-section-count">${ts.length}</span></div>`;
    if (!ts.length) { h += '<div class="empty-state-msg">No feature-level test scenarios.</div>'; }
    else {
        h += '<ul class="scenario-list" aria-label="Test scenarios">';
        ts.forEach(item => {
            const pc = item.priority==='P0'?'priority-p0':item.priority==='P1'?'priority-p1':item.priority==='P2'?'priority-p2':'priority-p3';
            h += `<li class="scenario-item">
                <div class="scenario-item-header">
                    <span class="priority-badge ${pc}">${esc(item.priority||'')}</span>
                    <span class="scenario-title">${esc(item.title||'')}</span>
                    ${item.type?`<span class="tag-chip">${esc(item.type)}</span>`:''}
                </div>
                ${item.description?`<div class="scenario-desc">${esc(item.description)}</div>`:''}
                ${item.expectedResult?`<div class="scenario-desc" style="color:var(--success);margin-top:3px;">Expected: ${esc(item.expectedResult)}</div>`:''}
            </li>`;
        });
        h += '</ul>';
    }
    h += '</div>';

    // Refinement Steps
    h += `<div class="detail-section">
        <div class="detail-section-title" role="progressbar" aria-valuenow="${completedSteps}" aria-valuemin="0" aria-valuemax="${totalSteps}" aria-label="Refinement progress">
            &#8635; Refinement Progress <span class="detail-section-count">${completedSteps}/${totalSteps}</span>
        </div>`;
    if (!steps.length) { h += '<div class="empty-state-msg">No refinement steps recorded.</div>'; }
    else {
        h += '<ul class="steps-list" aria-label="Refinement steps">';
        steps.forEach(step => {
            const done = step.completed;
            h += `<li class="step-item">
                <span class="step-number ${done?'complete':'incomplete'}">${step.stepNumber||'?'}</span>
                <span style="${done?'color:var(--text)':'color:var(--text-muted)'}">${esc(step.summary||step.description||'Step '+(step.stepNumber||''))}</span>
            </li>`;
        });
        h += '</ul>';
    }
    h += '</div>';

    // Clarifications
    if (clarifications.length) {
        h += `<div class="detail-section"><div class="detail-section-title">&#63; Clarifications <span class="detail-section-count">${clarifications.length}</span></div><ul class="steps-list">`;
        clarifications.forEach(c => {
            h += `<li class="step-item" style="flex-direction:column;align-items:flex-start;gap:4px;">
                <div style="font-size:13px;font-weight:600;">Q: ${esc(c.question||'')}</div>
                ${c.answer?`<div style="font-size:12px;color:var(--text-secondary);">A: ${esc(c.answer)}</div>`:'<div style="font-size:12px;color:var(--text-muted);">Awaiting answer</div>'}
            </li>`;
        });
        h += '</ul></div>';
    }

    // Task Summary
    h += `<div class="detail-section"><div class="detail-section-title">&#9776; Task Summary <span class="detail-section-count">${allTasks.length}</span></div>`;
    if (!allTasks.length) { h += '<div class="empty-state-msg">No tasks yet.</div>'; }
    else {
        h += '<table class="task-table" aria-label="Task summary"><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Order</th></tr></thead><tbody>';
        [...allTasks].sort((a,b)=>a.orderOfExecution-b.orderOfExecution).forEach(t => {
            h += `<tr>
                <td style="font-weight:700;color:var(--primary);font-family:monospace;">${esc(t.taskId)}</td>
                <td>${esc(t.title)}</td>
                <td><span class="status-badge ${getBadgeClass(t.status)}" style="font-size:10px;">${formatStatus(t.status)}</span></td>
                <td style="text-align:center;">${t.orderOfExecution}</td>
            </tr>`;
        });
        h += '</tbody></table>';
    }
    h += '</div>';

    panel.innerHTML = h;
}

// ── Task Detail Modal ──
async function showTaskDetail(taskId) {
    try {
        const [sr, fr] = await Promise.all([
            fetch(`/api/task?featureSlug=${encodeURIComponent(currentSlug)}&id=${encodeURIComponent(taskId)}&repoName=${encodeURIComponent(currentRepo)}`),
            fetch(`/api/task/full?featureSlug=${encodeURIComponent(currentSlug)}&id=${encodeURIComponent(taskId)}&repoName=${encodeURIComponent(currentRepo)}`)
        ]);
        if (!sr.ok) throw new Error('Failed to load task');
        const sd = await sr.json();
        const fd = fr.ok ? await fr.json() : {};
        const task = {...fd, ...sd};
        renderTaskDetail(task);
        openModal('detailModal');
    } catch(e) { showToast(e.message,'error'); }
}

function renderTaskDetail(task) {
    document.getElementById('detailModalTitle').textContent = `${task.taskId} - ${task.title||formatStatus(task.status)}`;
    const body = document.getElementById('detailBody');
    const bc = getBadgeClass(task.status);
    let h = `<div class="tdetail-section"><div class="tdetail-section-title">Overview</div>
        <div class="tdetail-row"><span class="tdetail-label">Status</span><span class="tdetail-value"><span class="status-badge ${bc}">${formatStatus(task.status)}</span></span></div>
        <div class="tdetail-row"><span class="tdetail-label">Task ID</span><span class="tdetail-value">${esc(task.taskId)}</span></div>
        ${task.title?`<div class="tdetail-row"><span class="tdetail-label">Title</span><span class="tdetail-value">${esc(task.title)}</span></div>`:''}
        <div class="tdetail-row"><span class="tdetail-label">Order</span><span class="tdetail-value">${task.orderOfExecution}</span></div>
        ${task.estimatedHours?`<div class="tdetail-row"><span class="tdetail-label">Est. Hours</span><span class="tdetail-value">${task.estimatedHours}h</span></div>`:''}`;
    if (task.dependencies&&task.dependencies.length) h += `<div class="tdetail-row"><span class="tdetail-label">Dependencies</span><span class="tdetail-value">${task.dependencies.join(', ')}</span></div>`;
    if (task.tags&&task.tags.length) h += `<div class="tdetail-row"><span class="tdetail-label">Tags</span><span class="tdetail-value">${task.tags.join(', ')}</span></div>`;
    if (task.completedReviews&&task.completedReviews.length) h += `<div class="tdetail-row"><span class="tdetail-label">Completed Reviews</span><span class="tdetail-value">${task.completedReviews.map(formatStatus).join(', ')}</span></div>`;
    if (task.canTransitionTo&&task.canTransitionTo.length) h += `<div class="tdetail-row"><span class="tdetail-label">Can Transition To</span><span class="tdetail-value">${task.canTransitionTo.map(formatStatus).join(', ')}</span></div>`;
    h += '</div>';
    if (task.description) h += `<div class="tdetail-section"><div class="tdetail-section-title">Description</div><p style="font-size:13px;color:var(--text-secondary);white-space:pre-wrap;">${esc(task.description)}</p></div>`;
    if (task.acceptanceCriteria&&task.acceptanceCriteria.length) {
        h += '<div class="tdetail-section"><div class="tdetail-section-title">Acceptance Criteria</div><ul class="criteria-list">';
        task.acceptanceCriteria.forEach(ac => {
            const pc = ac.priority==='Must Have'?'priority-must':ac.priority==='Should Have'?'priority-should':'priority-could';
            h += `<li class="criteria-item"><span class="criteria-check">${ac.verified?'&#10004;':'&#9675;'}</span><span class="priority-badge ${pc}" style="font-size:10px;">${esc(ac.priority)}</span><span>${esc(ac.criterion)}</span></li>`;
        });
        h += '</ul></div>';
    }
    if (task.testScenarios&&task.testScenarios.length) {
        h += '<div class="tdetail-section"><div class="tdetail-section-title">Test Scenarios</div><ul class="criteria-list">';
        task.testScenarios.forEach(ts => {
            h += `<li class="criteria-item"><span class="priority-badge priority-p1" style="font-size:10px;">${esc(ts.priority)}</span><span><strong>${esc(ts.title)}</strong> — ${esc(ts.description)}${ts.manualOnly?' (Manual)':''}</span></li>`;
        });
        h += '</ul></div>';
    }
    if (task.outOfScope&&task.outOfScope.length) {
        h += '<div class="tdetail-section"><div class="tdetail-section-title">Out of Scope</div><ul style="list-style:disc;padding-left:18px;font-size:12px;color:var(--text-secondary);">';
        task.outOfScope.forEach(item => { h += `<li>${esc(item)}</li>`; });
        h += '</ul></div>';
    }
    if (task.transitions&&task.transitions.length) {
        h += '<div class="tdetail-section"><div class="tdetail-section-title">Transition History</div><ul class="transition-list">';
        task.transitions.forEach(tr => {
            h += `<li class="transition-item">
                <span>${formatStatus(tr.from)}</span><span class="transition-arrow">&rarr;</span><span>${formatStatus(tr.to)}</span>
                ${tr.actor?` <span style="color:var(--text-muted)">by ${formatStatus(tr.actor)}</span>`:''}
                ${tr.approver?` <span style="color:var(--text-muted)">by ${formatStatus(tr.approver)}</span>`:''}
                <span class="transition-time">${tr.timestamp?new Date(tr.timestamp).toLocaleString():''}</span>
                ${tr.notes?`<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${esc(tr.notes.slice(0,200))}${tr.notes.length>200?'…':''}</div>`:''}
            </li>`;
        });
        h += '</ul></div>';
    }
    if (task.stakeholderReview) {
        const reviews = Object.entries(task.stakeholderReview).filter(([,v])=>v);
        if (reviews.length) {
            h += '<div class="tdetail-section"><div class="tdetail-section-title">Stakeholder Reviews</div>';
            reviews.forEach(([role, r]) => {
                h += `<div style="margin-bottom:8px;padding:8px;background:var(--bg);border-radius:3px;font-size:12px;">
                    <div style="font-weight:700;margin-bottom:4px;">${formatStatus(role)} ${r.approved?'&#10004; Approved':'&#10006; Rejected'}</div>
                    ${r.notes?`<div style="color:var(--text-secondary);font-size:11px;">${esc(r.notes.slice(0,300))}${r.notes.length>300?'…':''}</div>`:''}
                </div>`;
            });
            h += '</div>';
        }
    }
    body.innerHTML = h;
}

// ── Register Repo (T03) ──
async function registerRepo(e) {
    e.preventDefault();
    const repoName = document.getElementById('repoNameInput').value.trim();
    const repoPath = document.getElementById('repoPathInput').value.trim();
    const repoUrl  = document.getElementById('repoUrlInput').value.trim();
    const defaultBranch = document.getElementById('repoBranchInput').value.trim() || 'main';
    const errEl = document.getElementById('repoFormError');
    errEl.style.display = 'none';

    if (!/^[a-z0-9][a-z0-9\-]*[a-z0-9]$|^[a-z0-9]$/.test(repoName)) {
        errEl.textContent = 'Repo name must be lowercase alphanumeric with hyphens, no leading/trailing hyphens.';
        errEl.style.display = 'block';
        document.getElementById('repoNameInput').focus();
        return;
    }
    if (/[;|&$`]/.test(repoPath)) {
        errEl.textContent = 'Repo path must not contain shell metacharacters (; | & $ `)';
        errEl.style.display = 'block';
        document.getElementById('repoPathInput').focus();
        return;
    }
    try {
        const res = await fetch('/api/repos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ repoName, repoPath, repoUrl: repoUrl||undefined, defaultBranch })
        });
        const data = await res.json();
        if (!res.ok) { errEl.textContent = data.error||'Failed to register'; errEl.style.display='block'; return; }
        showToast(`Repository "${esc(repoName)}" registered`, 'success');
        closeModal('repoModal');
        ['repoNameInput','repoPathInput','repoUrlInput'].forEach(id => document.getElementById(id).value='');
        document.getElementById('repoBranchInput').value='main';
        currentRepo = repoName;
        await loadRepos();
        announce(`Repository ${repoName} registered and selected`);
    } catch(err) { errEl.textContent = err.message||'An error occurred'; errEl.style.display='block'; }
}

// ── Create Feature ──
async function createFeature(e) {
    e.preventDefault();
    const slug = document.getElementById('newFeatureSlug').value.trim();
    const name = document.getElementById('newFeatureName').value.trim();
    if (!currentRepo) { showToast('Select a repository first','error'); return; }
    try {
        const res = await fetch('/api/features',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({featureSlug:slug,featureName:name,repoName:currentRepo})});
        if (!res.ok) { const err=await res.json(); throw new Error(err.error); }
        showToast('Feature created','success');
        closeModal('featureModal');
        document.getElementById('newFeatureSlug').value='';
        document.getElementById('newFeatureName').value='';
        await loadRepos();
        selectFeature(currentRepo, slug);
    } catch(err) { showToast(err.message,'error'); }
}

// ── Add Task ──
async function addTask(e) {
    e.preventDefault();
    const task = {
        taskId: document.getElementById('newTaskId').value.trim(),
        title: document.getElementById('newTaskTitle').value.trim(),
        description: document.getElementById('newTaskDescription').value.trim(),
        status: document.getElementById('newTaskStatus').value,
        orderOfExecution: parseInt(document.getElementById('newTaskOrder').value),
        estimatedHours: parseFloat(document.getElementById('newTaskHours').value)||null,
        dependencies:[], testScenarios:[], acceptanceCriteria:[]
    };
    try {
        const res = await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({featureSlug:currentSlug,task,repoName:currentRepo})});
        if (!res.ok) { const err=await res.json(); throw new Error(err.error); }
        showToast('Task added','success');
        closeModal('taskModal');
        ['newTaskId','newTaskTitle','newTaskDescription','newTaskHours'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('newTaskOrder').value='1';
        featureDetailCache={};
        await loadBoard(currentSlug); await loadRepos();
    } catch(err) { showToast(err.message,'error'); }
}

// ── Delete Feature ──
async function deleteFeature() {
    if (!currentSlug) return;
    if (!confirm(`Delete feature "${currentSlug}" and ALL its tasks? This cannot be undone.`)) return;
    try {
        const res = await fetch(`/api/features/${encodeURIComponent(currentSlug)}?repoName=${encodeURIComponent(currentRepo)}`,{method:'DELETE'});
        if (!res.ok) { const err=await res.json(); throw new Error(err.error); }
        showToast('Feature deleted','success');
        currentSlug=''; allTasks=[]; summaryData=null; featureDetailCache={};
        showEmptyState(); await loadRepos();
    } catch(err) { showToast(err.message,'error'); }
}

// ── Modals (T07: focus management) ──
function openModal(id) {
    const m = document.getElementById(id);
    m.classList.add('active');
    requestAnimationFrame(() => {
        const f = m.querySelector('input:not([disabled]),select,textarea,button:not([disabled])');
        if (f) f.focus();
    });
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// ── Edit Task ──
let editingTaskId = '';
async function editTask(taskId) {
    try {
        editingTaskId = taskId;
        const res = await fetch(`/api/task/full?featureSlug=${encodeURIComponent(currentSlug)}&id=${encodeURIComponent(taskId)}&repoName=${encodeURIComponent(currentRepo)}`);
        if (!res.ok) throw new Error('Failed to load task');
        const d = await res.json();
        document.getElementById('editTaskIdLabel').textContent = `(${taskId})`;
        document.getElementById('editTaskTitle').value = d.title||'';
        document.getElementById('editTaskDescription').value = d.description||'';
        document.getElementById('editTaskOrder').value = d.orderOfExecution||0;
        document.getElementById('editTaskHours').value = d.estimatedHours||'';
        document.getElementById('editTaskTags').value = (d.tags||[]).join(', ');
        document.getElementById('editTaskDependencies').value = (d.dependencies||[]).join(', ');
        document.getElementById('editTaskOutOfScope').value = (d.outOfScope||[]).join('\n');
        const acList = document.getElementById('editAcceptanceCriteriaList');
        acList.innerHTML = (d.acceptanceCriteria||[]).length ? '' : '<p style="font-size:12px;color:var(--text-muted);">No acceptance criteria</p>';
        (d.acceptanceCriteria||[]).forEach((ac,i) => acList.insertAdjacentHTML('beforeend', renderCriterionRow(i,ac)));
        const tsList = document.getElementById('editTestScenariosList');
        tsList.innerHTML = (d.testScenarios||[]).length ? '' : '<p style="font-size:12px;color:var(--text-muted);">No test scenarios</p>';
        (d.testScenarios||[]).forEach((ts,i) => tsList.insertAdjacentHTML('beforeend', renderScenarioRow(i,ts)));
        openModal('editTaskModal');
    } catch(err) { showToast(err.message,'error'); }
}

function renderCriterionRow(idx,ac) {
    return `<div class="criterion-row" style="display:flex;gap:6px;margin-bottom:6px;align-items:start;">
        <input type="text" class="ac-id" placeholder="AC-${idx+1}" value="${esc(ac.id||'')}" style="width:72px;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
        <select class="ac-priority" style="width:108px;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
            <option value="Must Have" ${ac.priority==='Must Have'?'selected':''}>Must Have</option>
            <option value="Should Have" ${ac.priority==='Should Have'?'selected':''}>Should Have</option>
            <option value="Could Have" ${ac.priority==='Could Have'?'selected':''}>Could Have</option>
        </select>
        <input type="text" class="ac-text" placeholder="Criterion" value="${esc(ac.criterion||'')}" style="flex:1;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
        <button type="button" onclick="removeRow(this)" aria-label="Remove" style="padding:3px 7px;border:none;background:var(--danger);color:#fff;border-radius:3px;cursor:pointer;font-size:12px;">&#10005;</button>
    </div>`;
}

function renderScenarioRow(idx,ts) {
    return `<div class="scenario-row" style="margin-bottom:10px;padding:8px;background:var(--bg);border-radius:3px;">
        <div style="display:flex;gap:6px;margin-bottom:5px;flex-wrap:wrap;">
            <input type="text" class="ts-id" placeholder="TS-${idx+1}" value="${esc(ts.id||'')}" style="width:72px;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
            <select class="ts-priority" style="width:68px;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
                <option value="P0" ${ts.priority==='P0'?'selected':''}>P0</option>
                <option value="P1" ${ts.priority==='P1'?'selected':''}>P1</option>
                <option value="P2" ${ts.priority==='P2'?'selected':''}>P2</option>
                <option value="P3" ${ts.priority==='P3'?'selected':''}>P3</option>
            </select>
            <input type="text" class="ts-title" placeholder="Title" value="${esc(ts.title||'')}" style="flex:1;min-width:100px;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;">
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" class="ts-manual" ${ts.manualOnly?'checked':''}> Manual</label>
            <button type="button" onclick="removeRow(this)" aria-label="Remove" style="padding:3px 7px;border:none;background:var(--danger);color:#fff;border-radius:3px;cursor:pointer;font-size:12px;">&#10005;</button>
        </div>
        <textarea class="ts-desc" placeholder="Description" style="width:100%;padding:5px 7px;border:1px solid var(--border);border-radius:3px;font-size:12px;resize:vertical;min-height:50px;">${esc(ts.description||'')}</textarea>
    </div>`;
}

function addCriterionRow() {
    const l = document.getElementById('editAcceptanceCriteriaList');
    if (l.querySelector('p')) l.innerHTML='';
    l.insertAdjacentHTML('beforeend', renderCriterionRow(l.querySelectorAll('.criterion-row').length,{id:'',priority:'Must Have',criterion:''}));
}
function addScenarioRow() {
    const l = document.getElementById('editTestScenariosList');
    if (l.querySelector('p')) l.innerHTML='';
    l.insertAdjacentHTML('beforeend', renderScenarioRow(l.querySelectorAll('.scenario-row').length,{id:'',priority:'P1',title:'',description:'',manualOnly:false}));
}
function removeRow(btn) { btn.closest('.criterion-row,.scenario-row').remove(); }

async function saveTaskEdits(e) {
    e.preventDefault();
    try {
        const updates = {};
        const title = document.getElementById('editTaskTitle').value.trim();
        const desc  = document.getElementById('editTaskDescription').value.trim();
        const order = parseInt(document.getElementById('editTaskOrder').value);
        const hours = parseFloat(document.getElementById('editTaskHours').value);
        if (title) updates.title = title;
        if (desc)  updates.description = desc;
        if (!isNaN(order)) updates.orderOfExecution = order;
        if (!isNaN(hours)) updates.estimatedHours = hours;
        const tags = document.getElementById('editTaskTags').value.trim();
        const deps = document.getElementById('editTaskDependencies').value.trim();
        const scope = document.getElementById('editTaskOutOfScope').value.trim();
        updates.tags = tags ? tags.split(',').map(t=>t.trim()).filter(t=>t) : [];
        updates.dependencies = deps ? deps.split(',').map(d=>d.trim()).filter(d=>d) : [];
        updates.outOfScope = scope ? scope.split('\n').map(s=>s.trim()).filter(s=>s) : [];
        updates.acceptanceCriteria = Array.from(document.querySelectorAll('.criterion-row')).map(r=>({
            id: r.querySelector('.ac-id').value.trim()||`AC-${Math.floor(Math.random()*1000)}`,
            priority: r.querySelector('.ac-priority').value,
            criterion: r.querySelector('.ac-text').value.trim(), verified:false
        })).filter(ac=>ac.criterion);
        updates.testScenarios = Array.from(document.querySelectorAll('.scenario-row')).map(r=>({
            id: r.querySelector('.ts-id').value.trim()||`TS-${Math.floor(Math.random()*1000)}`,
            priority: r.querySelector('.ts-priority').value,
            title: r.querySelector('.ts-title').value.trim(),
            description: r.querySelector('.ts-desc').value.trim(),
            manualOnly: r.querySelector('.ts-manual').checked
        })).filter(ts=>ts.title);
        const res = await fetch(`/api/tasks/${encodeURIComponent(editingTaskId)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({featureSlug:currentSlug,updates,repoName:currentRepo})});
        if (!res.ok) { const err=await res.json(); throw new Error(err.error||'Failed to update'); }
        showToast('Task updated','success');
        closeModal('editTaskModal');
        editingTaskId=''; featureDetailCache={};
        await loadBoard(currentSlug);
    } catch(err) { showToast(err.message,'error'); }
}

// ── Delete Task ──
let deletingTaskId = '';
function deleteTaskPrompt(taskId) {
    deletingTaskId = taskId;
    const t = allTasks.find(t=>t.taskId===taskId);
    document.getElementById('deleteTaskId').textContent = taskId;
    document.getElementById('deleteTaskTitle').textContent = t ? t.title : 'Unknown';
    openModal('deleteTaskModal');
}
async function confirmDeleteTask() {
    if (!deletingTaskId) return;
    try {
        const res = await fetch(`/api/tasks/${encodeURIComponent(deletingTaskId)}?featureSlug=${encodeURIComponent(currentSlug)}&repoName=${encodeURIComponent(currentRepo)}`,{method:'DELETE'});
        if (!res.ok) { const err=await res.json(); throw new Error(err.error||'Failed to delete'); }
        showToast('Task deleted','success');
        closeModal('deleteTaskModal');
        deletingTaskId=''; featureDetailCache={};
        await loadBoard(currentSlug); await loadRepos();
    } catch(err) { showToast(err.message,'error'); }
}

// ── Utils ──
function formatStatus(s) { if(!s)return''; return s.replace(/([A-Z])/g,' $1').trim(); }
function esc(str) { if(str==null)return''; const d=document.createElement('div'); d.textContent=String(str); return d.innerHTML; }
function getBadgeClass(s) {
    if(s==='Done') return 'badge-done';
    if(['InProgress','InReview','InQA'].includes(s)) return 'badge-active';
    if(['NeedsChanges','NeedsRefinement'].includes(s)) return 'badge-blocked';
    if(s&&s.startsWith('Pending')) return 'badge-review';
    return 'badge-pending';
}
function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast toast-'+type+' visible';
    setTimeout(() => t.classList.remove('visible'), 3500);
}

// Cleanup
window.addEventListener('beforeunload', () => { clearInterval(autoRefreshTimer); });
</script>
</body>
</html>
